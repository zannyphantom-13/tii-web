<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Course - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script src="user-loader.js"></script>
</head>
<body>
    <header>
        <a href="admin-portal.html">← Back to Admin</a>
    </header>
    <main style="max-width:800px;margin:40px auto;">
        <h2>Add New Course (Admin Only)</h2>

        <div id="not-admin-message" style="color:#555;margin-bottom:16px">
            Course creation is restricted. Please <a href="/Tii/admin-portal.html">open the Admin Portal</a> to manage courses.
        </div>

        <form id="upload-course-form" style="display:none;">
            <div class="form-group">
                <label for="title">Course Title</label>
                <input id="title" name="title" required />
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label for="placement">Display As</label>
                <select id="placement" name="placement">
                    <option value="other">Other Courses (card)</option>
                    <option value="curriculum">Curriculum List (button)</option>
                </select>
            </div>
            <button type="submit" class="submit-btn">Add Course</button>
            <div id="upload-course-message" style="margin-top:12px;"></div>
        </form>
    </main>
    <script>
    (function(){
        const API_URL = window.location.origin || 'http://localhost:3000';

        function parseJwt(token){ try{ if(!token) return null; const p = token.split('.')[1]; if(!p) return null; const b = p.replace(/-/g,'+').replace(/_/g,'/'); const json = decodeURIComponent(atob(b).split('').map(function(c){ return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join('')); return JSON.parse(json); }catch(e){return null} }

        const token = localStorage.getItem('authToken');
        const payload = parseJwt(token);
        const isAdmin = payload && payload.role === 'admin';

        const form = document.getElementById('upload-course-form');
        const msg = document.getElementById('not-admin-message');
        if (isAdmin && form) {
            form.style.display = '';
            if (msg) msg.style.display = 'none';
        } else {
            if (form) form.style.display = 'none';
            if (msg) msg.style.display = '';
            return; // not admin — do not attach submit handlers
        }

        document.getElementById('upload-course-form').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const placement = document.getElementById('placement').value || 'other';
            const out = document.getElementById('upload-course-message'); out.textContent='';
            try{
                const resp = await fetch(`${API_URL}/api/courses`,{
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ title, description, placement })
                });
                const jb = await resp.json().catch(()=>null);
                if (resp.ok) {
                    out.style.color = '#2a6e62'; out.textContent = 'Course added successfully.';
                    // show link to course
                    const link = document.createElement('a'); link.href = jb.url || '#'; link.target = '_blank'; link.textContent = 'Open course page'; link.className='explore-btn-secondary'; link.style.display='inline-block'; link.style.marginTop='8px'; out.appendChild(link);
                } else {
                    out.style.color='#c0392b'; out.textContent = `Failed to add course: ${jb && jb.message ? jb.message : resp.status}`;
                }
            } catch(err){ console.error(err); out.style.color='#c0392b'; out.textContent = 'Network error: '+err.message; }
        });
    })();
    </script>
</body>
</html>